


<!DOCTYPE html>
<html lang="en-US" data-bs-theme="dark">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#97C906" /> <!-- Add theme color meta tag -->
    <link rel="manifest" href="https://goblin.tools/site.webmanifest?v=_Aqfz49MTuLLrWBw0wBVhuBPd7kSzmQqdz6kwHZsMGI"> <!-- Add manifest link -->
    <meta name="google-play-app" content="app-id=com.goblintools" />
    <meta name="apple-itunes-app" content="app-id=6449003064" />
    <title>Magic ToDo - Goblin Tools</title>
    <link rel="stylesheet" href="https://goblin.tools/css/site.css?v=G0tSLcuTaOTRrwWGuYJ79TSv7DqmO8Y1u5-5eilWpPo" />
    <link rel="stylesheet" href="https://goblin.tools/GoblinTools.styles.css?v=wZe2_6p5mAuKVo1OONyUxG0sCI0LP419qiq_zGT8hlY" />
    <!-- Add favicon and app icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="https://goblin.tools/assets/apple-touch-icon.png?v=utJZDTQaz5vgeZO3b_ioTKY8cNnQJUn7a-oOmBNKeDU">
    <link rel="icon" type="image/png" sizes="32x32" href="https://goblin.tools/assets/favicon-32x32.png?v=E7_GSkDe7-nfJfjZhkjwm7IUd-E_5sCjpEAUolNcwzI">
    <link rel="icon" type="image/png" sizes="16x16" href="https://goblin.tools/assets/favicon-16x16.png?v=yBr4TsokmoWVS5YnO7TUSZS1z7Il2K00M5eALOs_zEo">
    <link rel="mask-icon" href="/assets/safari-pinned-tab.svg?v=OOMGIxrXngBvwSdbBJawfdcCHk_wxy6nZCFORTlZQ18" color="#CCE969">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.13.2/jquery-ui.min.js"></script>
    <script src="https://goblin.tools/ext/toastify-js.js?v=WCvsu2K7qBKFNHhVz3An24MbI-ZBnInEJ9BeTDzqB0E"></script>
    <script src="https://goblin.tools/ext/popper.min.js?v=whL0tQWoY1Ku1iskqPFvmZ-CHsvmRWx_PIoEvIeWh4I"></script>
    <script src="https://goblin.tools/ext/tippy.min.js?v=Pw_nDrJszyj2iHoZLinTjdfvfC8HmnMwStQt3HvtN94"></script>
    <script src="https://goblin.tools/ext/readable-seconds.js?v=oS4VfJqsqvV1Gb1iNnWd3LXpXBiRvTBQSnl2u7WR2Lk"></script>
    <script src="https://goblin.tools/ext/timestring.js?v=7F6aVBfH_OqpS4awzs3EoOIlFj0xfrzsSr8ZJz-GgfE"></script>

    <link rel="stylesheet" href="https://goblin.tools/ext/all.min.css?v=mUZM63G8m73Mcidfrv5E-Y61y7a12O5mW4ezU3bxqW4">
    <link href="https://goblin.tools/ext/bootstrap.min.css?v=Fu5_PVNGJlC70y4mPEjA6nWVdPz2IMaBrXGQCJEsRho" rel="stylesheet">
    <link href="https://goblin.tools/ext/toastify.min.css?v=eFUVNXYEdruIhSK1ZToG6bt7FwYzdFdKkEBEZrpM7lg" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">
    <script src="https://goblin.tools/ext/bootstrap.bundle.min.js?v=6o_gIaSs5PZ4b-zEGPcLZY_C3ALRNuj-XGq2tipG1dA"></script>
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
    <script src="https://goblin.tools/ext/jquery.ui.touch-punch.min.js?v=LPzJt5IMKR_MqvmQWIsMvpCaABdFC5nKhd_jJBmSsw8"></script>
    <script>
        (function () {
        var htmlElement = document.querySelector('html');
        var theme = localStorage.getItem('theme');
        if (theme === 'dark') {
        htmlElement.setAttribute('data-bs-theme', 'dark');
        } else {
        htmlElement.setAttribute('data-bs-theme', 'light');
        }
        })();
    </script>
        <!-- Appzi: Capture Insightful Feedback -->
        <script async src="https://w.appzi.io/w.js?token=ac3uB"></script>
    <style>
        .navbar .navbar-collapse {
            text-align: center;
        }

        @media (max-width: 1200px) {
            .nav-item {
                border-radius: 6px !important;
            }

            .navbar-brand img {
                height: 40px !important;
            }
        }

        .navbar-brand img {
            height: 60px;
            padding: 0px 10px;
        }


        .nav-item:first-of-type {
            border-radius: 6px 0 0 6px;
        }


        .nav-item:last-of-type {
            border-radius: 0 6px 6px 0;
        }

        .app-button {
            width: 100px;
            height: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--bs-nav-link-padding-y) var(--bs-nav-link-padding-x);
            font-size: var(--bs-nav-link-font-size);
            font-weight: var(--bs-nav-link-font-weight);
            color: var(--bs-nav-link-color) !important;
            text-decoration: none;
            background: 0 0;
            border: 0;
            transition: color .15s ease-in-out,background-color .15s ease-in-out,border-color .15s ease-in-out;
        }

            .app-button:hover {
                color: var(--bs-nav-link-hover-color) !important;
            }

        #teacher-tools img {
            width: 120px;
            height: auto;
            margin-left: 0px;
            margin-bottom: 2px;
            vertical-align: text-bottom;
        }

        [data-bs-theme=light] #teacher-tools img {
            content: url('/assets/TT logo black.png');
        }

        [data-bs-theme=dark] #teacher-tools img {
            content: url('/assets/TT logo white.png');
        }

        .links-section {
            margin-top: 2rem;
        }

        .links-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            margin-bottom: 5px;
        }

        .top-app-text {
            display: none;
        }

        .bottom-app-text {
            display: block;
        }


        @media (max-width: 768px) {
            .links-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .links-section {
                padding-bottom: 4rem; /* Extra padding on mobile to avoid footer overlap */
            }

            .top-app-text {
                display: block;
            }

            .bottom-app-text {
                display: none;
            }
        }

        .links-category {
            text-align: center;
        }

            .links-category h3 {
                font-size: 1.2rem;
                margin-bottom: 1rem;
            }

        .links-buttons {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        @media (max-width: 768px) {
            .links-buttons {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
            }
        }

        .app-link {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 1rem;
            border: 1px solid var(--bs-border-color);
            border-radius: 0.25rem;
            text-decoration: none;
            color: var(--bs-body-color) !important;
            transition: all 0.2s ease;
            width: 100%;
            justify-content: center;
        }

            .app-link:hover {
                background-color: var(--bs-tertiary-bg);
                text-decoration: none;
                color: var(--bs-body-color) !important;
            }

            .app-link i {
                margin-right: 0.5rem;
                font-size: 1.5rem;
            }
    </style>

    <script src="https://goblin.tools/js/site.js?v=t7MWrAHyPqg-sNcGw6iQzHBTFooHQfXwf1hy6JqA2yU"></script>

        <script src="https://goblin.tools/js/voice.js?v=vUkdkN6rZwba-HNK-qH0LWjoeip4ZvOHtg4YNbrD7lA"></script>
    <style>
        body {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            margin: 0;
        }

        .container-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

            .container-wrapper > .container:last-child {
                margin-top: auto;
            }

        footer.footer {
            margin-top: auto;
        }

        @media (max-width: 768px) {
            body {
                margin-bottom: 0;
            }
        }
    </style>
    <style>
        .theme-toggle-split {
            display: inline-flex;
            align-items: center;
            border: 1px solid var(--bs-border-color);
            border-radius: 0.375rem;
            padding: 0;
            overflow: hidden;
            background: var(--bs-body-bg);
        }

            .theme-toggle-split.theme-toggle-rounded {
                border-radius: 50px;
            }

            .theme-toggle-split .theme-icon-wrapper {
                padding: 0.5rem 1rem;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: background-color 0.15s ease-in-out;
                cursor: pointer;
            }

                .theme-toggle-split .theme-icon-wrapper:hover {
                    background-color: var(--bs-tertiary-bg);
                }

                .theme-toggle-split .theme-icon-wrapper.inactive {
                    opacity: 0.4;
                }

            .theme-toggle-split .theme-divider {
                width: 1px;
                height: 28px;
                background-color: var(--bs-border-color);
            }

        [data-bs-theme="light"] .theme-toggle-split .theme-icon-light {
            opacity: 1;
        }

        [data-bs-theme="light"] .theme-toggle-split .theme-icon-dark {
            opacity: 0.4;
        }

        [data-bs-theme="dark"] .theme-toggle-split .theme-icon-light {
            opacity: 0.4;
        }

        [data-bs-theme="dark"] .theme-toggle-split .theme-icon-dark {
            opacity: 1;
        }

        /* Mobile menu spacing */
        @media (max-width: 1199px) {
            .navbar-nav.ms-auto {
                border-top: 1px solid var(--bs-border-color);
                padding-top: 1rem;
                margin-top: 1rem;
                margin-bottom: 1rem;
            }
        }
    </style>
    <style>
        .language-selector-wrapper {
            position: relative;
        }

            .language-selector-wrapper .fa-globe {
                position: absolute;
                top: 50%;
                left: 1rem; /* 16px */
                transform: translateY(-50%);
                z-index: 2; /* Ensure icon is above the select box */
                pointer-events: none; /* Make the icon non-interactive */
            }

            /* Add padding to the Choices.js generated element */
            .language-selector-wrapper .choices__inner {
                padding-left: 2.5rem; /* 40px, adjust as needed */
            }

        .choices__list--dropdown .choices__item--selectable[data-select-text], .choices__list[aria-expanded] .choices__item--selectable[data-select-text] {
            padding-right: 10px !important;
        }

        @media (max-width: 1200px) {
            .language-selector-wrapper {
                padding-left: 10px !important;
                padding-right: 10px !important;
            }
        }


        .choices__inner {
            background-color: var(--bs-body-bg) !important;
            padding: 1px 7.5px 1.75px 40px !important;
            border: 1px solid var(--bs-border-color);
            border-radius: 6px !important;
            font-size: 14px;
            min-height: 0 !important;
        }

        .choices__list--dropdown, .choices__list[aria-expanded] {
            border-bottom-left-radius: 6px;
            border-bottom-right-radius: 6px;
        }


        .choices__list--dropdown, .choices__list[aria-expanded], .choices__input {
            background-color: var(--bs-body-bg) !important;
            border: 1px solid var(--bs-border-color) !important;
            z-index: 1000;
        }

        .choices__list--single {
            padding: 4px 20px 4px 4px;
        }

    </style>
</head>
<body>
    <header b-0bai7cs8n1>
        <nav b-0bai7cs8n1 class="navbar navbar-expand-xl  navbar-toggleable-xl navbar-light border-bottom box-shadow mb-3  ">
            <div b-0bai7cs8n1 class="container">
                <a class="navbar-brand" href="https://goblin.tools/"><img b-0bai7cs8n1 src="/assets/logo.png" /><span b-0bai7cs8n1 class="printable">goblin.tools</span></a>
                    <button b-0bai7cs8n1 class="navbar-toggler unprintable" type="button" data-bs-toggle="collapse" data-bs-target=".navbar-collapse" aria-controls="navbarSupportedContent"
                            aria-expanded="false" aria-label="Toggle navigation">
                        <span b-0bai7cs8n1 class="navbar-toggler-icon"></span>
                    </button>

                <div b-0bai7cs8n1 class="navbar-collapse unprintable collapse d-xl-inline-flex justify-content-between">
                        <ul b-0bai7cs8n1 class="navbar-nav">
                            <li b-0bai7cs8n1 class="nav-item border shadow-sm ">
                                <a class="nav-link mx-1" data-tooltip="Break down to-do items" href="https://goblin.tools/ToDo">Magic ToDo</a>
                            </li>
                            <li b-0bai7cs8n1 class="nav-item border shadow-sm ">
                                <a class="nav-link mx-1" data-tooltip="Text transformers for tone" href="https://goblin.tools/Formalizer">Formalizer</a>
                            </li>
                            <li b-0bai7cs8n1 class="nav-item border shadow-sm ">
                                <a class="nav-link mx-1" data-tooltip="Read a text for emotion" href="https://goblin.tools/Judge">Judge</a>
                            </li>
                            <li b-0bai7cs8n1 class="nav-item border shadow-sm ">
                                <a class="nav-link mx-1" data-tooltip="Explain anything" href="https://goblin.tools/Professor">Professor</a>
                            </li>
                            <li b-0bai7cs8n1 class="nav-item border shadow-sm ">
                                <a class="nav-link mx-1" data-tooltip="Help me decide" href="https://goblin.tools/Consultant">Consultant</a>
                            </li>
                            <li b-0bai7cs8n1 class="nav-item border shadow-sm ">
                                <a class="nav-link mx-1" data-tooltip="Guess an activity's timeframe" href="https://goblin.tools/Estimator">Estimator</a>
                            </li>
                            <li b-0bai7cs8n1 class="nav-item border shadow-sm ">
                                <a class="nav-link mx-1" data-tooltip="Turn a braindump into actions" href="https://goblin.tools/Compiler">Compiler</a>
                            </li>
                            <li b-0bai7cs8n1 class="nav-item border shadow-sm ">
                                <a class="nav-link mx-1" data-tooltip="Create a recipe from ingredients" href="https://goblin.tools/Chef">Chef</a>
                            </li>
                        </ul>
                    <ul b-0bai7cs8n1 class="navbar-nav ms-auto">
                        <li b-0bai7cs8n1 class="nav-item">
                            
<div class="d-flex flex-column gap-2">
    <!-- New Centering Wrapper -->
    <div class="d-flex justify-content-center">
        <!-- Unified Theme Toggle -->
        <div class="theme-toggle-split theme-toggle" data-tooltip="Switch light/dark mode">
            <div class="theme-icon-wrapper theme-icon-light">
                <i class="fas fa-sun"></i>
            </div>
            <div class="theme-divider"></div>
            <div class="theme-icon-wrapper theme-icon-dark">
                <i class="fas fa-moon"></i>
            </div>
        </div>
    </div>

    <!-- Unified Language Selector -->
    <div class="language-selector-wrapper">
        <i class="fas fa-globe"></i>
        <select class="form-select language-selector" aria-label="Select Language">
         
        </select>
    </div>
</div>
                        </li>
                    </ul>
                </div>
            </div>


        </nav>
    </header>
    <div b-0bai7cs8n1 class="container-wrapper">
        <div b-0bai7cs8n1 class="container">
            <main b-0bai7cs8n1 role="main" class="pb-3 position-relative">
                    <div b-0bai7cs8n1 class="container unprintable help-container position-relative">
                        <button b-0bai7cs8n1 id="help-toggle" aria-label="Help" class="btn btn-sm btn-outline-danger rounded-full position-absolute top-0 end-0">
                            Help&nbsp;<i b-0bai7cs8n1 class="fas fa-question"></i>
                        </button>
                        <div b-0bai7cs8n1 id="help-content" class="border border-2 rounded p-3 position-absolute end-0" style="display:none; top:2rem; ">
                            <p>Magic Todo acts as a standard todo list, with some special sauce. Try the <i class="fas fa-magic"></i> button and let it automatically come up with the steps you need to accomplish your task! </p><p>The ÔÑÜ spiciness level ÔÑÜ gives the tool a hint about how hard or stressful you find the task. The spicier, the more steps it will attempt to break it down into. It's not an exact measure, more a hint to the system.</p><p>Top level tasks are automatically assigned a category indicated by an emoji. You can filter your list to one or more categories with the <i class="fas fa-filter"></i> button. The filter button also allows you to hide all completed items.</p><p>Common task tools (edit, remove, add subtask, and estimator) are under the <i class="fas fa-ellipsis-v"></i> button on each item. The <i class="fas fa-grip-vertical"></i> icon on the left can be dragged to reorder items to anywhere.</p><p>Additional actions for the entire list can be found below it. They include <i class="fas fa-sync"></i> synchronization between devices, <i class="fas fa-share-alt-square"></i> export options , undo and redo, and <i class="fas fa-hammer"></i> bulk actions.</p>
                        </div>
                    </div>
                

<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="https://goblin.tools/css/print.css?v=yFwkqqvkRS5D7KDRw8wDuV4aVeUd-UODR-FgznnPbuk" media="print" />
    <link rel="stylesheet" href="https://goblin.tools/ext/duration.css?v=liGQWSgROmfD7hkiin-RwqhrAfRvMSDSwVMMk7l4Hdc" />

    <style>
        .checkbox-container {
            flex-shrink: 0;
            width: 20px;
        }

        .spinner-border {
            display: none;
        }

        .parent-todo {
            margin-bottom: 8px;
        }

        .spiciness-indicator {
            position: absolute;
            font-size: 0.6rem;
            transform: translateY(-100%);
        }

        .edit-input {
            display: inline;
            margin-right: 5px;
        }

        .edit-input-container {
            width: 100%;
        }

        .edit-confirm,
        .edit-cancel {
            display: inline;
            margin-left: 2px;
            padding: 0 4px;
        }

        .todoText {
            user-select: text !important;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
        }

        #categoryFilterMenu {
            --bs-dropdown-min-width: 10px !important;
            --bs-dropdown-item-padding-x: 0;
        }

            #categoryFilterMenu .form-check {
                padding-left: 2rem;
                padding-right: 0.4rem;
                text-align: center;
                align-content: center;
            }

        .list-group-item-content {
            margin: -6px 0 -6px -16px;
            /*padding: var(--bs-list-group-item-padding-y) var(--bs-list-group-item-padding-x);*/
            padding: var(--bs-list-group-item-padding-y) 8px var(--bs-list-group-item-padding-y) 12px !important;
        }

            .list-group-item-content:hover {
                background-color: var(--bs-tertiary-bg);
            }

        #child-frame {
            display: none;
        }

        .highlight {
            background-color: var(--bs-tertiary-bg);
        }

        .list-group-item {
            outline: var(--bs-list-group-border-width) solid var(--bs-list-group-border-color) !important;
            padding: var(--bs-list-group-item-padding-y) 0 var(--bs-list-group-item-padding-y) 18px !important;
            margin: -1px;
            border: 0px !important;
            box-sizing: content-box !important;
        }

    </style>

    <script src="https://goblin.tools/js/todo-base.js?v=OfD-uR59zBdynmGBp1H6pja5dMLa_mzmk0YjeVqQRFI"></script>
    <script src="https://goblin.tools/js/crypto.js?v=19BFZlMgWUZcO0BfVwEfZKyLdtT1yfFzo2ULIj6pI6c"></script>
    <script src="https://goblin.tools/ext/duration.js?v=mKit9b9PNmarWuwUwEBfIdG4FVvFCRvHv5TZSbFVqkM"></script>

</head>
<body>
    <div class="container">
        <h1 class="text-center unprintable">Magic ToDo</h1>
        <h2 class="text-center mb-5 unprintable">Breaking things down so you don't</h2>

        <div class="input-group unprintable mb-3">
            <input data-voice id="new-item" type="text" class="form-control" placeholder="Add new item...">
            <button id="add-item" data-tooltip="Add" aria-label="add new item" class="btn btn-primary rounded-end">
                <i class="fas fa-plus"></i>
                <span class="spinner-border spinner-border-sm"></span>
            </button>
            <div id="spicycontainer" data-tooltip="Spiciness level:" class="inline invisible mx-2">
                <button id="spiciness-toggle" class="btn border">
                    üå∂Ô∏èüå∂Ô∏èüå∂Ô∏è
                </button>
            </div>
            <div id="spiciness-wrapper" class="position-absolute rounded border-2 border p-3" style="display: none; background-color: var(--bs-body-bg); z-index: 999; width: 20rem; right: 0.5rem; bottom: 2.6rem;">
                <label for="spiciness" class="font-weight-bold">Spiciness level:</label>
                <div class="position-relative">
                    <div class="mb-3 mt-1" style="margin-top: -0.5rem; font-size:0.9rem;">How much breaking down do you need? You can change this anytime, and it'll apply to all items!</div>
                    <input type="range" class="form-range" id="spiciness" min="1" max="5" step="1" value="3" style="width: 100%;">
                    <span class="spiciness-indicator" style="left: 0;">üå∂Ô∏è</span>
                    <span class="spiciness-indicator text-nowrap" style="right: 0;">üå∂Ô∏èüå∂Ô∏èüå∂Ô∏èüå∂Ô∏èüå∂Ô∏è</span>
                </div>
            </div>

        </div>
        <div id="todo-list" class="list-group"></div>
        <div id="exportButtons" class="unprintable" style="display: flex; justify-content: space-between;">

            <div class="dropup">
                <button id="sync-toggle" data-bs-toggle="dropdown" class="btn btn-outline-success dropdown-toggle" data-tooltip="Sync" style="height: 40px; min-width: 60px;" aria-label="Synchronize now" onclick="runSync()">
                    <i class="fas fa-sync"></i>&nbsp; Sync
                </button>
                <div id="sync-wrapper" class="rounded border-2 border p-3 dropdown-menu" style="background-color: var(--bs-body-bg); z-index: 999; width: 20rem; ">
                    <div id="syncContainer" class="container">
                        <div class="text-danger text-center mb-0">BETA FEATURE</div>
                        <div class="text-danger form-text text-center mb-2 mt-0">use at your own risk</div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="" id="syncCheck">
                            <label class="form-check-label" for="syncCheck">
                                Enable cloud synchronization
                            </label>
                        </div>
                        <div class="form-group">
                            <label for="username">Username</label>
                            <input type="text" class="form-control" id="username" disabled minlength="3">
                        </div>
                        <div class="form-group">
                            <label for="password">Password</label>
                            <input type="password" class="form-control" id="password" disabled minlength="3">
                        </div>
                        <div class="d-flex justify-content-end my-2">
                            <button id="saveButton" class="btn btn-primary flex-fill mx-1">Save</button>
                            <button id="cancelButton" class="btn btn-secondary flex-fill mx-1">Cancel</button>
                        </div>
                        <div id="syncHelp" class="form-text text-muted">
                            Please provide credentials to synchronize your ToDo list across devices.<br>There are no accounts, your username must simply be unique.<br>We recommend taking a backup with <i class="fas fa-download"></i> before activating sync on new devices.<br />
                            <a data-bs-toggle="collapse" href="#collapseText" role="button" aria-expanded="false" aria-controls="collapseText">
                                How does this work?
                            </a>
                            <div class="collapse" id="collapseText">
                                All devices with the same username and password will synchronize lists.<br>Your list is encrypted on your devices using your username and password. It can't be seen or decrypted by admins or anyone who doesn't have your credentials.<br>Synchronization is not instant, it can take a few seconds for your changes to come through on other devices.
                            </div>
                        </div>
                    </div>
                </div>
   <button class="btn btn-outline-secondary dropdown-toggle" data-tooltip="Export" style="height: 40px; width: 60px;" type="button" id="exportButtonsDropdown" data-bs-toggle="dropdown" aria-label="open share options" aria-haspopup="true" aria-expanded="false">
                    <i class="fas fa-share-alt-square"></i>
                </button>
                <div class="dropdown-menu dropup p-2" id="exportButtonsMenu">
                    <a id="save" class="dropdown-item export" onclick="downloadAsFile(JSON.stringify(todos), 'magic_todo.goblin')" style="height: 2.3rem; padding:4px 4px;">
                        <i class="fas fa-download fa-lg" style="width: 1.5rem; height: 1.5rem; padding-left: 4px"></i>
                        <span>Save to file</span>
                    </a>
                    <a id="load" class="dropdown-item" onclick="loadFromFile(x => { saveTodos(x); loadTodo();}, '.goblin')" style="height: 2.3rem; padding:4px 4px;">
                        <i class="fas fa-upload fa-lg" style="width: 1.5rem; height: 1.5rem; padding-left: 4px"></i>
                        <span>Load from saved file</span>
                    </a>
                    <a id="copy" class="dropdown-item export" onclick="copyToClipboard()" style="height: 2.3rem; padding:4px 4px;">
                        <i class="fas fa-copy fa-lg" style="width: 1.5rem; height: 1.5rem; padding-left: 4px"></i>
                        <span>Copy to clipboard</span>
                    </a>
                    <a id="print" class="dropdown-item export" onclick="window.print()" style="height: 2.3rem; padding:4px 4px;">
                        <i class="fas fa-print fa-lg" style="width: 1.5rem; height: 1.5rem; padding-left: 4px"></i>
                        <span>Print</span>
                    </a>
                    <a id="todoist" class="dropdown-item export" onclick="downloadAsFile(convertToTodoist(), 'magic_todo_todoist.csv')" style="height: 2.3rem; padding:4px 4px;">
                        <img src="https://goblin.tools/assets/todoist.ico?v=ENrFCgCNIagzUsld77MiFIu5lyW_GkTs7grQyBUGKdc" style="width: 1.5rem; height: 1.5rem; padding-left: 0" />
                        <span>Export to Todoist template</span>
                    </a>

                    <a id="ical" class="dropdown-item export" onclick="downloadAsFile(convertToICal(), 'magic_todo_ical.ics')" style="height: 2.3rem; padding:4px 4px;">
                        <img src="https://goblin.tools/assets/ical.ico?v=caz6_pKbKOTEdHK9-W_KLQJwhDGbMgSFB5E8kt4WDXE" style="width: 1.8rem; height: 1.8rem; margin: 0 -2px" />
                        <span>Export to iCal file</span>
                    </a>
                </div>
            </div>
            <div style="display: flex; justify-content: space-between;">

                <div id="categoryFilter" class="dropup" style="display: none;">
                    <button class="btn dropdown-toggle" data-tooltip="Filters" type="button" id="categoryFilterDropdown" data-bs-toggle="dropdown" aria-label="Filters" aria-haspopup="true" aria-expanded="false">
                        <i class="fas fa-filter"></i>
                    </button>
                    <div class="dropdown-menu" id="categoryFilterMenu" aria-labelledby="categoryFilterDropdown">
                        <!-- Category checkboxes will be generated here -->
                    </div>
                </div>
                    <button id="undo" class="btn mx-1 btn-outline-secondary" disabled data-tooltip="Undo" style="height: 40px; width: 40px;" aria-label="Undo" onclick="undo()"><i class="fas fa-undo"></i></button>
                    <button id="redo" class="btn btn-outline-secondary" disabled data-tooltip="Redo" style="height: 40px; width: 40px;" aria-label="Redo" onclick="redo()"><i class="fas fa-redo"></i></button>
                <div id="bulkStuff" class="dropup">
                    <button class="btn btn-outline-secondary ms-1 dropdown-toggle export" data-tooltip="Clear entire list" style="height: 40px; width: 60px;" type="button" id="bulkMenuDropdown" data-bs-toggle="dropdown" aria-label="Clear entire list" aria-haspopup="true" aria-expanded="false">
                        <i class="fas fa-hammer"></i>
                    </button>
                    <div class="dropdown-menu dropdown-menu-end p-2" id="bulkMenu">
                        <div class="dropdown-item export"><button class="magic btn btn-sm btn-outline-primary  w-100" onclick="EstimateAll()"><i class="fas fa-clock"></i> Estimate</button></div>
                        <div class="dropdown-item export"><button class="magic btn btn-sm btn-outline-info  w-100" onclick="uncheckAllTasks()"><i class="fas fa-tasks"></i> Mark all as not completed</button></div>
                        <div class="dropdown-item export"><button class="magic btn btn-sm btn-outline-secondary  w-100" onclick="clearAllEstimates()"><i class="fas fa-stop-circle"></i> Clear all estimates</button></div>
                        <div class="dropdown-item export"><button class="magic btn btn-sm btn-outline-success  w-100" onclick="clearAllCompletedTasks()"><i class="fas fa-broom"></i> Clear all completed tasks</button></div>
                        <div class="dropdown-item export"><button class="magic btn btn-sm btn-outline-danger  w-100" onclick="clearAllTasks()"><i class="fas fa-quidditch"></i> Clear entire list</button></div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script src="https://goblin.tools/js/todo-exports.js?v=8-esrvK-xTbl3eEvA_1IBOroIvI8w60igLG76kx2-RM"></script>
    <script src="https://goblin.tools/js/todo.js?v=FurVvp0ET8HTJypAdpvBQAwZtGkPeAJHsKNkLhE4Oqc"></script>
    <script src="https://goblin.tools/js/todo-sync.js?v=W5DZ5Cmt1eDZ_6xpk-FnxR3LjqzUPe0vimj2Na2utMU"></script>
</body>
</html>


            </main>
        </div>

        <div b-0bai7cs8n1 class="container">
            <div b-0bai7cs8n1 class="links-section">

                    <div b-0bai7cs8n1 class="text-center mb-3">
                        <a b-0bai7cs8n1 href="https://tchr.tools?utm_source=goblin&utm_term=tool" target="_blank" class="text-reset text-decoration-none">
                            <p b-0bai7cs8n1 class="mb-0 normal" id="teacher-tools">
                                <b b-0bai7cs8n1>Check out <img src="/assets/TT logo black.png" class="align-middle" alt="Teacher Tools" style="height:1.2rem;"> for more</b>
                            </p>
                        </a>
                    </div>
                <hr b-0bai7cs8n1 class="mb-3" />
                <div b-0bai7cs8n1 class="links-grid">
                        <div b-0bai7cs8n1 class="links-category">
                            <h3 b-0bai7cs8n1>Mobile Apps</h3>

                            <p b-0bai7cs8n1 class="top-app-text">App purchases keep Goblin Tools free</p>
                            <div b-0bai7cs8n1 class="links-buttons">
                                <a b-0bai7cs8n1 href="https://play.google.com/store/apps/details?id=com.goblintools" target="_blank" class="app-link">
                                    <i b-0bai7cs8n1 class="fab fa-android" style="color: #a4c639;"></i>
                                    Android
                                </a>
                                <a b-0bai7cs8n1 href="https://apps.apple.com/app/goblin-tools/id6449003064" target="_blank" class="app-link">
                                    <i b-0bai7cs8n1 class="fab fa-apple"></i>
                                    iOS
                                </a>
                                <p b-0bai7cs8n1 class="bottom-app-text">App purchases keep Goblin Tools free</p>
                            </div>
                        </div>
                    <div b-0bai7cs8n1 class="links-category">
                        <h3 b-0bai7cs8n1>Learn More</h3>
                        <div b-0bai7cs8n1 class="links-buttons">
                            <a b-0bai7cs8n1 href="/About" class="app-link">
                                <i b-0bai7cs8n1 class="fas fa-info-circle"></i>
                                About
                            </a>
                            <a b-0bai7cs8n1 href="/Privacy" class="app-link">
                                <i b-0bai7cs8n1 class="fas fa-shield-alt"></i>
                                Privacy
                            </a>
                        </div>
                    </div>

                    <div b-0bai7cs8n1 class="links-category">
                        <h3 b-0bai7cs8n1>Support</h3>
                        <div b-0bai7cs8n1 class="links-buttons">
                            <a b-0bai7cs8n1 href="https://www.patreon.com/GoblinTools" target="_blank" class="app-link">
                                <i b-0bai7cs8n1 class="fab fa-patreon"></i>
                                Patreon
                            </a>
                                <a b-0bai7cs8n1 href="#" class="app-link" onclick="appzi && appzi.openSurvey('3497fc0e-c96e-4299-9393-5ea76e45575a'); return false;">
                                    <i b-0bai7cs8n1 class="fas fa-heart"></i>
                                    Feedback
                                </a>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <script>

        // Add event listener for theme toggle - support multiple instances
        document.querySelectorAll('.theme-toggle').forEach(function(toggle) {
        toggle.addEventListener('click', toggleTheme);
        });

        // Apply the stored theme on page load
        document.addEventListener('DOMContentLoaded', function () {
        var storedTheme = localStorage.getItem('theme');
        if (storedTheme) {
        setTheme(storedTheme);
        } else {
        setTheme('light')
        }

        var isOpera = (!!window.opr && !!opr.addons) || !!window.opera || navigator.userAgent.indexOf(' OPR/') >= 0;
        if (isOpera) {
        var pwabutton = $("#pwa-button")
        pwabutton.addClass("disabled");
        pwabutton.text("Not supported in your browser!")

        }

        });

        var helpContent = $('#help-content');
        function toggleHelpContent(e) {
        helpContent.toggle();

        e.stopPropagation();
        }

        $('#help-toggle').on('click', toggleHelpContent);


        var appsContent = $('#apps-content');
        function toggleAppsContent(e) {
        appsContent.toggle();

        e.stopPropagation();
        }

        $('#apps-toggle').on('click', toggleAppsContent);



        $('html').on('click', function (e) {
        if (helpContent.is(":visible")) {
        helpContent.toggle();
        e.stopPropagation();
        }
        if (appsContent.is(":visible")) {
        appsContent.toggle();
        e.stopPropagation();
        }
        });

        document.addEventListener('click', function (event) {
        var isClickInsideMenu = document.querySelector('.navbar-collapse').contains(event.target);
        var toggler = document.querySelector('.navbar-toggler');

        var isClickOnToggler = toggler ? toggler.contains(event.target) : false;

        if (!isClickInsideMenu && !isClickOnToggler) {
        $('.navbar-collapse').collapse('hide');
        }
        });

        // Helper function to read language from IndexedDB
        function getLanguageFromIndexedDB() {
            return new Promise((resolve, reject) => {
                var request = indexedDB.open('goblin-tools-db', 1);
                
                request.onupgradeneeded = function(event) {
                    var db = event.target.result;
                    if (!db.objectStoreNames.contains('settings')) {
                        db.createObjectStore('settings');
                    }
                };
                
                request.onsuccess = function(event) {
                    var db = event.target.result;
                    var transaction = db.transaction('settings', 'readonly');
                    var store = transaction.objectStore('settings');
                    var getRequest = store.get('gt_lang');
                    
                    getRequest.onsuccess = function() {
                        resolve(getRequest.result);
                    };
                    
                    getRequest.onerror = function() {
                        resolve(null);
                    };
                };
                
                request.onerror = function(event) {
                    console.error('[Page] Failed to read from IndexedDB:', event.target.error);
                    resolve(null);
                };
            });
        }

        // Helper function to save language to IndexedDB for service worker
        function saveLanguageToIndexedDB(languageCode) {
            var request = indexedDB.open('goblin-tools-db', 1);
            
            request.onupgradeneeded = function(event) {
                var db = event.target.result;
                if (!db.objectStoreNames.contains('settings')) {
                    db.createObjectStore('settings');
                }
            };
            
            request.onsuccess = function(event) {
                var db = event.target.result;
                var transaction = db.transaction('settings', 'readwrite');
                var store = transaction.objectStore('settings');
                store.put(languageCode, 'gt_lang');
                console.log('[Page] Saved language to IndexedDB:', languageCode);
            };
            
            request.onerror = function(event) {
                console.error('[Page] Failed to save language to IndexedDB:', event.target.error);
            };
        }

        // Language selector change handler - made async to wait for IndexedDB
        async function handleLanguageChange() {
            var selectedLanguage = this.value;

            // Save to localStorage SYNCHRONOUSLY (most reliable in WebViews)
            try {
                localStorage.setItem('gt_lang', selectedLanguage);
                console.log('[Page] Saved language to localStorage:', selectedLanguage);
            } catch (e) {
                console.error('[Page] Failed to save language to localStorage:', e);
            }

            // Notify service worker to invalidate caches
            if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                try {
                    var messageChannel = new MessageChannel();
                    navigator.serviceWorker.controller.postMessage({
                        type: 'INVALIDATE_LANGUAGE_CACHE',
                        newLanguage: selectedLanguage
                    }, [messageChannel.port2]);
                    
                    await new Promise(function(resolve) {
                        messageChannel.port1.onmessage = function() { resolve(); };
                        setTimeout(resolve, 100);
                    });
                } catch (error) {
                    console.warn('[Language] Could not notify service worker:', error);
                }
            }

            // Save to IndexedDB SYNCHRONOUSLY before redirecting
            try {
                await new Promise(function(resolve, reject) {
                    var request = indexedDB.open('goblin-tools-db', 1);
                    
                    request.onerror = function() {
                        console.warn('[Language] IndexedDB open failed, continuing anyway');
                        resolve();
                    };
                    
                    request.onsuccess = function(event) {
                        var db = event.target.result;
                        try {
                            var transaction = db.transaction('settings', 'readwrite');
                            var store = transaction.objectStore('settings');
                            store.put(selectedLanguage, 'gt_lang');
                            
                            // CRITICAL: Wait for transaction to complete
                            transaction.oncomplete = function() {
                                console.log('[Language] IndexedDB updated successfully');
                                resolve();
                            };
                            
                            transaction.onerror = function() {
                                console.warn('[Language] IndexedDB transaction failed, continuing anyway');
                                resolve();
                            };
                            
                            // Timeout fallback - don't wait forever
                            setTimeout(function() {
                                console.warn('[Language] IndexedDB commit timeout, continuing anyway');
                                resolve();
                            }, 500);
                        } catch (e) {
                            console.warn('[Language] IndexedDB error:', e);
                            resolve();
                        }
                    };
                    
                    request.onupgradeneeded = function(event) {
                        var db = event.target.result;
                        if (!db.objectStoreNames.contains('settings')) {
                            db.createObjectStore('settings');
                        }
                    };
                });
            } catch (error) {
                console.warn('[Language] IndexedDB failed:', error);
            }

            // Call server endpoint to set cookie
            $.ajax({
                url: "https://" + window.location.host + '/api/setlanguage',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ LanguageCode: selectedLanguage }),
                success: function(response) {
                    // Always append ?l=XX to URL for consistency
                    window.location.href = window.location.pathname + '?l=' + selectedLanguage;
                },
                error: function() {
                    console.error('Error setting language - falling back to client-side cookie');
                    
                    // Fallback to client-side cookie setting if server call fails
                    var expires = new Date();
                    expires.setFullYear(expires.getFullYear() + 1);

                    var cookieString = 'gt_lang=' + selectedLanguage + '; path=/; SameSite=Lax; expires=' + expires.toUTCString();
                    if (window.location.hostname.endsWith('goblin.tools')) {
                        cookieString += '; domain=.goblin.tools';
                    }

                    if (window.location.protocol === 'https:') {
                        cookieString += '; Secure';
                    }

                    document.cookie = cookieString;

                    // Reload with language parameter
                    window.location.href = window.location.pathname + '?l=' + selectedLanguage;
                }
            });
        }

        // Initialize Choices.js on all language selectors
        document.querySelectorAll('.language-selector').forEach(function(selector) {
        // const options = Array.from(selector.options);
        // console.log(JSON.stringify(options[0]))

        // const dataoptions = options.map(option => ({
        //     value: option.value,
        //     label: option.dataset.nativeName,
        //     id: option.index + 1,
        //     customProperties: {
        //         nativeName: option.dataset.nativeName,
        //         englishName: option.dataset.englishName
        //     }
        // }));

        const dataoptions = [

                                                                                                {
                                                                                                                    value: "en-US",
                                                                                                                    label: "US English",
                                                                                                                id: 44 + 1,
                                                                                      disabled: false,
                                                                                                        customProperties: {
                                                                                                                        nativeName: "US English",
                                                                                                                        englishName: "English",
                                                                                                        }
                                                                                },
                
                                                                                        {
                                                                                                    value: "en",
                                                                                                    label: "English",
                                                                                                id: 0 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "English",
                                                                                                        englishName: "English",
                                                                                                }
                                                                        },
                
                                                                                        {
                                                                                                    value: "af",
                                                                                                    label: "Afrikaans",
                                                                                                id: 1 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "Afrikaans",
                                                                                                        englishName: "Afrikaans",
                                                                                                }
                                                                        },
                
                                                                                        {
                                                                                                    value: "en-AU",
                                                                                                    label: "Australian",
                                                                                                id: 2 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "Australian",
                                                                                                        englishName: "English",
                                                                                                }
                                                                        },
                
                                                                                        {
                                                                                                    value: "id",
                                                                                                    label: "Bahasa Indonesia",
                                                                                                id: 3 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "Bahasa Indonesia",
                                                                                                        englishName: "Indonesian",
                                                                                                }
                                                                        },
                
                                                                                        {
                                                                                                    value: "ms",
                                                                                                    label: "Bahasa Melayu",
                                                                                                id: 4 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "Bahasa Melayu",
                                                                                                        englishName: "Malay",
                                                                                                }
                                                                        },
                
                                                                                        {
                                                                                                    value: "bs",
                                                                                                    label: "Bosanski",
                                                                                                id: 5 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "Bosanski",
                                                                                                        englishName: "Bosnian",
                                                                                                }
                                                                        },
                
                                                                                        {
                                                                                                    value: "en-GB",
                                                                                                    label: "British",
                                                                                                id: 6 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "British",
                                                                                                        englishName: "English",
                                                                                                }
                                                                        },
                
                                                                                        {
                                                                                                    value: "cs",
                                                                                                    label: "&#x10C;e&#x161;tina",
                                                                                                id: 7 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "&#x10C;e&#x161;tina",
                                                                                                        englishName: "Czech",
                                                                                                }
                                                                        },
                
                                                                                        {
                                                                                                    value: "cy",
                                                                                                    label: "Cymraeg",
                                                                                                id: 8 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "Cymraeg",
                                                                                                        englishName: "Welsh",
                                                                                                }
                                                                        },
                
                                                                                        {
                                                                                                    value: "da",
                                                                                                    label: "Dansk",
                                                                                                id: 9 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "Dansk",
                                                                                                        englishName: "Danish",
                                                                                                }
                                                                        },
                
                                                                                        {
                                                                                                    value: "de",
                                                                                                    label: "Deutsch",
                                                                                                id: 10 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "Deutsch",
                                                                                                        englishName: "German",
                                                                                                }
                                                                        },
                
                                                                                        {
                                                                                                    value: "et",
                                                                                                    label: "Eesti",
                                                                                                id: 11 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "Eesti",
                                                                                                        englishName: "Estonian",
                                                                                                }
                                                                        },
                
                                                                                        {
                                                                                                    value: "es",
                                                                                                    label: "Espa&#xF1;ol",
                                                                                                id: 12 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "Espa&#xF1;ol",
                                                                                                        englishName: "Spanish",
                                                                                                }
                                                                        },
                
                                                                                        {
                                                                                                    value: "eu",
                                                                                                    label: "Euskera",
                                                                                                id: 13 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "Euskera",
                                                                                                        englishName: "Basque",
                                                                                                }
                                                                        },
                
                                                                                        {
                                                                                                    value: "fr",
                                                                                                    label: "Fran&#xE7;ais",
                                                                                                id: 14 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "Fran&#xE7;ais",
                                                                                                        englishName: "French",
                                                                                                }
                                                                        },
                
                                                                                        {
                                                                                                    value: "ga",
                                                                                                    label: "Gaeilge",
                                                                                                id: 15 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "Gaeilge",
                                                                                                        englishName: "Irish",
                                                                                                }
                                                                        },
                
                                                                                        {
                                                                                                    value: "gd",
                                                                                                    label: "G&#xE0;idhlig",
                                                                                                id: 16 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "G&#xE0;idhlig",
                                                                                                        englishName: "Scottish Gaelic",
                                                                                                }
                                                                        },
                
                                                                                        {
                                                                                                    value: "ha",
                                                                                                    label: "Hausa",
                                                                                                id: 17 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "Hausa",
                                                                                                        englishName: "Hausa",
                                                                                                }
                                                                        },
                
                                                                                        {
                                                                                                    value: "hr",
                                                                                                    label: "Hrvatski",
                                                                                                id: 18 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "Hrvatski",
                                                                                                        englishName: "Croatian",
                                                                                                }
                                                                        },
                
                                                                                        {
                                                                                                    value: "ig",
                                                                                                    label: "Igbo",
                                                                                                id: 19 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "Igbo",
                                                                                                        englishName: "Igbo",
                                                                                                }
                                                                        },
                
                                                                                        {
                                                                                                    value: "is",
                                                                                                    label: "&#xCD;slenska",
                                                                                                id: 20 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "&#xCD;slenska",
                                                                                                        englishName: "Icelandic",
                                                                                                }
                                                                        },
                
                                                                                        {
                                                                                                    value: "it",
                                                                                                    label: "Italiano",
                                                                                                id: 21 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "Italiano",
                                                                                                        englishName: "Italian",
                                                                                                }
                                                                        },
                
                                                                                        {
                                                                                                    value: "sw",
                                                                                                    label: "Kiswahili",
                                                                                                id: 22 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "Kiswahili",
                                                                                                        englishName: "Swahili",
                                                                                                }
                                                                        },
                
                                                                                        {
                                                                                                    value: "tlh",
                                                                                                    label: "Klingon",
                                                                                                id: 23 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "Klingon",
                                                                                                        englishName: "Klingon",
                                                                                                }
                                                                        },
                
                                                                                        {
                                                                                                    value: "la",
                                                                                                    label: "Latin",
                                                                                                id: 24 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "Latin",
                                                                                                        englishName: "Latin",
                                                                                                }
                                                                        },
                
                                                                                        {
                                                                                                    value: "lv",
                                                                                                    label: "Latvie&#x161;u",
                                                                                                id: 25 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "Latvie&#x161;u",
                                                                                                        englishName: "Latvian",
                                                                                                }
                                                                        },
                
                                                                                        {
                                                                                                    value: "lt",
                                                                                                    label: "Lietuvi&#x173;",
                                                                                                id: 26 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "Lietuvi&#x173;",
                                                                                                        englishName: "Lithuanian",
                                                                                                }
                                                                        },
                
                                                                                        {
                                                                                                    value: "hu",
                                                                                                    label: "Magyar",
                                                                                                id: 27 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "Magyar",
                                                                                                        englishName: "Hungarian",
                                                                                                }
                                                                        },
                
                                                                                        {
                                                                                                    value: "nl",
                                                                                                    label: "Nederlands",
                                                                                                id: 28 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "Nederlands",
                                                                                                        englishName: "Dutch",
                                                                                                }
                                                                        },
                
                                                                                        {
                                                                                                    value: "no",
                                                                                                    label: "Norsk",
                                                                                                id: 29 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "Norsk",
                                                                                                        englishName: "Norwegian",
                                                                                                }
                                                                        },
                
                                                                                        {
                                                                                                    value: "uz",
                                                                                                    label: "O&#x27;zbek",
                                                                                                id: 30 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "O&#x27;zbek",
                                                                                                        englishName: "Uzbek",
                                                                                                }
                                                                        },
                
                                                                                        {
                                                                                                    value: "pl",
                                                                                                    label: "Polski",
                                                                                                id: 31 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "Polski",
                                                                                                        englishName: "Polish",
                                                                                                }
                                                                        },
                
                                                                                        {
                                                                                                    value: "pt",
                                                                                                    label: "Portugu&#xEA;s",
                                                                                                id: 32 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "Portugu&#xEA;s",
                                                                                                        englishName: "Portuguese",
                                                                                                }
                                                                        },
                
                                                                                        {
                                                                                                    value: "qya",
                                                                                                    label: "Quenya",
                                                                                                id: 33 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "Quenya",
                                                                                                        englishName: "Quenya",
                                                                                                }
                                                                        },
                
                                                                                        {
                                                                                                    value: "ro",
                                                                                                    label: "Rom&#xE2;n&#x103;",
                                                                                                id: 34 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "Rom&#xE2;n&#x103;",
                                                                                                        englishName: "Romanian",
                                                                                                }
                                                                        },
                
                                                                                        {
                                                                                                    value: "sq",
                                                                                                    label: "Shqip",
                                                                                                id: 35 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "Shqip",
                                                                                                        englishName: "Albanian",
                                                                                                }
                                                                        },
                
                                                                                        {
                                                                                                    value: "sjn",
                                                                                                    label: "Sindarin",
                                                                                                id: 36 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "Sindarin",
                                                                                                        englishName: "Sindarin",
                                                                                                }
                                                                        },
                
                                                                                        {
                                                                                                    value: "sk",
                                                                                                    label: "Sloven&#x10D;ina",
                                                                                                id: 37 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "Sloven&#x10D;ina",
                                                                                                        englishName: "Slovak",
                                                                                                }
                                                                        },
                
                                                                                        {
                                                                                                    value: "sl",
                                                                                                    label: "Sloven&#x161;&#x10D;ina",
                                                                                                id: 38 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "Sloven&#x161;&#x10D;ina",
                                                                                                        englishName: "Slovene",
                                                                                                }
                                                                        },
                
                                                                                        {
                                                                                                    value: "fi",
                                                                                                    label: "Suomi",
                                                                                                id: 39 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "Suomi",
                                                                                                        englishName: "Finnish",
                                                                                                }
                                                                        },
                
                                                                                        {
                                                                                                    value: "sv",
                                                                                                    label: "Svenska",
                                                                                                id: 40 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "Svenska",
                                                                                                        englishName: "Swedish",
                                                                                                }
                                                                        },
                
                                                                                        {
                                                                                                    value: "tl",
                                                                                                    label: "Tagalog",
                                                                                                id: 41 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "Tagalog",
                                                                                                        englishName: "Tagalog",
                                                                                                }
                                                                        },
                
                                                                                        {
                                                                                                    value: "vi",
                                                                                                    label: "Ti&#x1EBF;ng Vi&#x1EC7;t",
                                                                                                id: 42 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "Ti&#x1EBF;ng Vi&#x1EC7;t",
                                                                                                        englishName: "Vietnamese",
                                                                                                }
                                                                        },
                
                                                                                        {
                                                                                                    value: "tr",
                                                                                                    label: "T&#xFC;rk&#xE7;e",
                                                                                                id: 43 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "T&#xFC;rk&#xE7;e",
                                                                                                        englishName: "Turkish",
                                                                                                }
                                                                        },
                
                                                                                        {
                                                                                                    value: "yo",
                                                                                                    label: "Yor&#xF9;b&#xE1;",
                                                                                                id: 45 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "Yor&#xF9;b&#xE1;",
                                                                                                        englishName: "Yoruba",
                                                                                                }
                                                                        },
                
                                                                                        {
                                                                                                    value: "el",
                                                                                                    label: "&#x395;&#x3BB;&#x3BB;&#x3B7;&#x3BD;&#x3B9;&#x3BA;&#x3AC;",
                                                                                                id: 46 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "&#x395;&#x3BB;&#x3BB;&#x3B7;&#x3BD;&#x3B9;&#x3BA;&#x3AC;",
                                                                                                        englishName: "Greek",
                                                                                                }
                                                                        },
                
                                                                                        {
                                                                                                    value: "bg",
                                                                                                    label: "&#x411;&#x44A;&#x43B;&#x433;&#x430;&#x440;&#x441;&#x43A;&#x438;",
                                                                                                id: 47 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "&#x411;&#x44A;&#x43B;&#x433;&#x430;&#x440;&#x441;&#x43A;&#x438;",
                                                                                                        englishName: "Bulgarian",
                                                                                                }
                                                                        },
                
                                                                                        {
                                                                                                    value: "ky",
                                                                                                    label: "&#x41A;&#x44B;&#x440;&#x433;&#x44B;&#x437;&#x447;&#x430;",
                                                                                                id: 48 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "&#x41A;&#x44B;&#x440;&#x433;&#x44B;&#x437;&#x447;&#x430;",
                                                                                                        englishName: "Kyrgyz",
                                                                                                }
                                                                        },
                
                                                                                        {
                                                                                                    value: "kk",
                                                                                                    label: "&#x49A;&#x430;&#x437;&#x430;&#x49B; &#x442;&#x456;&#x43B;&#x456;",
                                                                                                id: 49 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "&#x49A;&#x430;&#x437;&#x430;&#x49B; &#x442;&#x456;&#x43B;&#x456;",
                                                                                                        englishName: "Kazakh",
                                                                                                }
                                                                        },
                
                                                                                        {
                                                                                                    value: "mk",
                                                                                                    label: "&#x41C;&#x430;&#x43A;&#x435;&#x434;&#x43E;&#x43D;&#x441;&#x43A;&#x438;",
                                                                                                id: 50 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "&#x41C;&#x430;&#x43A;&#x435;&#x434;&#x43E;&#x43D;&#x441;&#x43A;&#x438;",
                                                                                                        englishName: "Macedonian",
                                                                                                }
                                                                        },
                
                                                                                        {
                                                                                                    value: "ru",
                                                                                                    label: "&#x420;&#x443;&#x441;&#x441;&#x43A;&#x438;&#x439;",
                                                                                                id: 51 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "&#x420;&#x443;&#x441;&#x441;&#x43A;&#x438;&#x439;",
                                                                                                        englishName: "Russian",
                                                                                                }
                                                                        },
                
                                                                                        {
                                                                                                    value: "sr",
                                                                                                    label: "&#x421;&#x440;&#x43F;&#x441;&#x43A;&#x438;",
                                                                                                id: 52 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "&#x421;&#x440;&#x43F;&#x441;&#x43A;&#x438;",
                                                                                                        englishName: "Serbian",
                                                                                                }
                                                                        },
                
                                                                                        {
                                                                                                    value: "tg",
                                                                                                    label: "&#x422;&#x43E;&#x4B7;&#x438;&#x43A;&#x4E3;",
                                                                                                id: 53 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "&#x422;&#x43E;&#x4B7;&#x438;&#x43A;&#x4E3;",
                                                                                                        englishName: "Tajik",
                                                                                                }
                                                                        },
                
                                                                                        {
                                                                                                    value: "he",
                                                                                                    label: "&#x5E2;&#x5D1;&#x5E8;&#x5D9;&#x5EA;",
                                                                                                id: 54 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "&#x5E2;&#x5D1;&#x5E8;&#x5D9;&#x5EA;",
                                                                                                        englishName: "Hebrew",
                                                                                                }
                                                                        },
                
                                                                                        {
                                                                                                    value: "ur",
                                                                                                    label: "&#x627;&#x631;&#x62F;&#x648;",
                                                                                                id: 55 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "&#x627;&#x631;&#x62F;&#x648;",
                                                                                                        englishName: "Urdu",
                                                                                                }
                                                                        },
                
                                                                                        {
                                                                                                    value: "ar",
                                                                                                    label: "&#x627;&#x644;&#x639;&#x631;&#x628;&#x64A;&#x629;",
                                                                                                id: 56 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "&#x627;&#x644;&#x639;&#x631;&#x628;&#x64A;&#x629;",
                                                                                                        englishName: "Standard Arabic",
                                                                                                }
                                                                        },
                
                                                                                        {
                                                                                                    value: "fa",
                                                                                                    label: "&#x641;&#x627;&#x631;&#x633;&#x6CC;",
                                                                                                id: 57 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "&#x641;&#x627;&#x631;&#x633;&#x6CC;",
                                                                                                        englishName: "Farsi",
                                                                                                }
                                                                        },
                
                                                                                        {
                                                                                                    value: "am",
                                                                                                    label: "&#x12A0;&#x121B;&#x122D;&#x129B;",
                                                                                                id: 58 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "&#x12A0;&#x121B;&#x122D;&#x129B;",
                                                                                                        englishName: "Amharic",
                                                                                                }
                                                                        },
                
                                                                                        {
                                                                                                    value: "ne",
                                                                                                    label: "&#x928;&#x947;&#x92A;&#x93E;&#x932;&#x940;",
                                                                                                id: 59 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "&#x928;&#x947;&#x92A;&#x93E;&#x932;&#x940;",
                                                                                                        englishName: "Nepali",
                                                                                                }
                                                                        },
                
                                                                                        {
                                                                                                    value: "mr",
                                                                                                    label: "&#x92E;&#x930;&#x93E;&#x920;&#x940;",
                                                                                                id: 60 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "&#x92E;&#x930;&#x93E;&#x920;&#x940;",
                                                                                                        englishName: "Marathi",
                                                                                                }
                                                                        },
                
                                                                                        {
                                                                                                    value: "hi",
                                                                                                    label: "&#x939;&#x93F;&#x928;&#x94D;&#x926;&#x940;",
                                                                                                id: 61 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "&#x939;&#x93F;&#x928;&#x94D;&#x926;&#x940;",
                                                                                                        englishName: "Hindi",
                                                                                                }
                                                                        },
                
                                                                                        {
                                                                                                    value: "bn",
                                                                                                    label: "&#x9AC;&#x9BE;&#x982;&#x9B2;&#x9BE;",
                                                                                                id: 62 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "&#x9AC;&#x9BE;&#x982;&#x9B2;&#x9BE;",
                                                                                                        englishName: "Bengali",
                                                                                                }
                                                                        },
                
                                                                                        {
                                                                                                    value: "pa",
                                                                                                    label: "&#xA2A;&#xA70;&#xA1C;&#xA3E;&#xA2C;&#xA40;",
                                                                                                id: 63 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "&#xA2A;&#xA70;&#xA1C;&#xA3E;&#xA2C;&#xA40;",
                                                                                                        englishName: "Punjabi",
                                                                                                }
                                                                        },
                
                                                                                        {
                                                                                                    value: "gu",
                                                                                                    label: "&#xA97;&#xAC1;&#xA9C;&#xAB0;&#xABE;&#xAA4;&#xAC0;",
                                                                                                id: 64 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "&#xA97;&#xAC1;&#xA9C;&#xAB0;&#xABE;&#xAA4;&#xAC0;",
                                                                                                        englishName: "Gujarati",
                                                                                                }
                                                                        },
                
                                                                                        {
                                                                                                    value: "ta",
                                                                                                    label: "&#xBA4;&#xBAE;&#xBBF;&#xBB4;&#xBCD;",
                                                                                                id: 65 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "&#xBA4;&#xBAE;&#xBBF;&#xBB4;&#xBCD;",
                                                                                                        englishName: "Tamil",
                                                                                                }
                                                                        },
                
                                                                                        {
                                                                                                    value: "te",
                                                                                                    label: "&#xC24;&#xC46;&#xC32;&#xC41;&#xC17;&#xC41;",
                                                                                                id: 66 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "&#xC24;&#xC46;&#xC32;&#xC41;&#xC17;&#xC41;",
                                                                                                        englishName: "Telugu",
                                                                                                }
                                                                        },
                
                                                                                        {
                                                                                                    value: "th",
                                                                                                    label: "&#xE44;&#xE17;&#xE22;",
                                                                                                id: 67 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "&#xE44;&#xE17;&#xE22;",
                                                                                                        englishName: "Thai",
                                                                                                }
                                                                        },
                
                                                                                        {
                                                                                                    value: "ko",
                                                                                                    label: "&#xD55C;&#xAD6D;&#xC5B4;",
                                                                                                id: 68 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "&#xD55C;&#xAD6D;&#xC5B4;",
                                                                                                        englishName: "Korean",
                                                                                                }
                                                                        },
                
                                                                                        {
                                                                                                    value: "zh",
                                                                                                    label: "&#x4E2D;&#x6587;",
                                                                                                id: 69 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "&#x4E2D;&#x6587;",
                                                                                                        englishName: "Chinese",
                                                                                                }
                                                                        },
                
                                                                                        {
                                                                                                    value: "ja",
                                                                                                    label: "&#x65E5;&#x672C;&#x8A9E;",
                                                                                                id: 70 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "&#x65E5;&#x672C;&#x8A9E;",
                                                                                                        englishName: "Japanese",
                                                                                                }
                                                                        },
                
                                                                                        {
                                                                                                    value: "zh-CN",
                                                                                                    label: "&#x7B80;&#x4F53;&#x4E2D;&#x6587;",
                                                                                                id: 71 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "&#x7B80;&#x4F53;&#x4E2D;&#x6587;",
                                                                                                        englishName: "Chinese (Simplified)",
                                                                                                }
                                                                        },
                
                                                                                        {
                                                                                                    value: "zh-TW",
                                                                                                    label: "&#x7E41;&#x9AD4;&#x4E2D;&#x6587;",
                                                                                                id: 72 + 1,
                                                                              disabled: false,
                                                                                                customProperties: {
                                                                                                        nativeName: "&#x7E41;&#x9AD4;&#x4E2D;&#x6587;",
                                                                                                        englishName: "Chinese (Traditional)",
                                                                                                }
                                                                        },
                                    ]
                    const selected = dataoptions.find(option => option.value === "en-US");
                    //console.log(JSON.stringify(selected))
                    const choicesInstance = new Choices(selector, {
                        searchEnabled: true,
                        itemSelectText: '',
                        shouldSort: false,
                       choices: dataoptions,
                        items: selected,
                        renderSelectedChoices: true,
                        searchFields: ['label', 'value', 'customProperties.englishName','customProperties.nativeName'],
                        callbackOnCreateTemplates: function (template) {
                            return {
                                item: ({classNames}, data) => {
                                    //console.log("Item: " + JSON.stringify(data))
                                    //var mydata = dataoptions.find(option => option.value === data.value);
                                    return template(`

                                        <div class="${classNames.item} ${data.highlighted ? classNames.highlightedState : classNames.itemSelectable}" data-item data-id="${data.id}" data-value="${data.value}" ${data.active ? 'aria-selected="true"' : ''} ${data.disabled ? 'aria-disabled="true"' : ''}>
                                             ${data.customProperties.nativeName}
                                        </div>
                                    `);
                                },
                                choice: ({classNames}, data) => {
                                    //console.log("Choice: " + JSON.stringify(data))
                                    //var mydata = dataoptions.find(option => option.value === data.value);
                                    return template(`

                                        <div class="${classNames.item} ${classNames.itemChoice} ${data.disabled ? classNames.itemDisabled : classNames.itemSelectable}" data-select-text="${this.config.itemSelectText}" data-choice data-id="${data.id}" data-value="${data.value}" ${data.disabled ? 'aria-disabled="true"' : ''} id="${data.elementId}">
                                            <div class="language-native-bold">${data.customProperties.nativeName}</div>
                                            <div class="language-english-italic">${data.customProperties.englishName}</div>
                                        </div>
                                    `);
                                }
                            };
                        }
                    });


                   //  choicesInstance.setChoices(dataoptions, 'value', 'label', true);
                   // choicesInstance.setChoiceByValue(selected.value);

                    selector.addEventListener('change', handleLanguageChange);
                });

        // Initialize IndexedDB with current language on page load
        (function() {
            var currentLang = 'en-US';
            if (currentLang) {
                saveLanguageToIndexedDB(currentLang);
            }
        })();

        // Synchronize language across all storage locations
        (async function() {
            var detectedLang = null;
            
            try {
                // Priority 1: Check URL query parameter ?l=XX
                var urlParams = new URLSearchParams(window.location.search);
                var langParam = urlParams.get('l');
                if (langParam) {
                    localStorage.setItem('gt_lang', langParam);
                    detectedLang = langParam;
                    console.log('[Lang Sync] Language set from URL parameter:', langParam);
                }
                
                // Priority 2: Read from localStorage (single source of truth)
                if (!detectedLang) {
                    detectedLang = localStorage.getItem('gt_lang');
                    if (detectedLang) {
                        console.log('[Lang Sync] Language from localStorage:', detectedLang);
                    }
                }
                
                // Priority 3: Fallback to browser language
                if (!detectedLang && navigator.languages && navigator.languages.length > 0) {
                    detectedLang = navigator.languages[0];
                    localStorage.setItem('gt_lang', detectedLang);
                    console.log('[Lang Sync] Language from navigator.languages:', detectedLang);
                }
                
                // Sync cookie and IndexedDB to match localStorage
                if (detectedLang) {
                    // Sync cookie via API call
                    $.ajax({
                        url: "https://" + window.location.host + '/api/setlanguage',
                        method: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({ LanguageCode: detectedLang }),
                        success: function() {
                            console.log('[Lang Sync] Cookie synced to:', detectedLang);
                        },
                        error: function() {
                            console.warn('[Lang Sync] Failed to sync cookie via API, setting directly');
                            var cookieString = 'gt_lang=' + detectedLang + '; path=/; max-age=31536000; SameSite=Lax';
                            if (window.location.hostname.endsWith('goblin.tools')) {
                                cookieString += '; domain=.goblin.tools';
                            }
                            if (window.location.protocol === 'https:') {
                                cookieString += '; Secure';
                            }
                            document.cookie = cookieString;
                        }
                    });
                    
                    // Sync IndexedDB
                    saveLanguageToIndexedDB(detectedLang);
                    console.log('[Lang Sync] IndexedDB synced to:', detectedLang);
                }
            } catch (e) {
                console.error('[Lang Sync] Failed to sync language:', e);
            }
        })();

        // Propagate language parameter across navigation
        document.addEventListener('DOMContentLoaded', function() {
            // Intercept all link clicks
            document.addEventListener('click', async function(e) {
                var target = e.target;

                // Find the closest <a> tag (in case user clicked child element)
                while (target && target.tagName !== 'A') {
                    target = target.parentElement;
                }

                // Not a link, ignore
                if (!target || target.tagName !== 'A') return;

                var href = target.getAttribute('href');

                // Skip if no href, or external links, or anchors, or javascript:
                if (!href ||
                    href.startsWith('#') ||
                    href.startsWith('javascript:') ||
                    href.startsWith('mailto:') ||
                    href.startsWith('tel:') ||
                    target.target === '_blank') {
                    return;
                }

                // Check if it's a same-domain link
                try {
                    var linkUrl = new URL(href, window.location.href);

                    // Only modify same-domain links
                    if (linkUrl.hostname === window.location.hostname) {
                        // Prevent default navigation
                        e.preventDefault();

                        // Check if this is a mobile domain link
                        var isMobileDomain = linkUrl.hostname === 'android.goblin.tools' ||
                                            linkUrl.hostname === 'ios.goblin.tools';

                        // Only add language parameter for mobile domains
                        if (isMobileDomain) {
                            // Read language from localStorage (single source of truth)
                            var currentLang = localStorage.getItem('gt_lang');
                            
                            if (currentLang) {
                                // Sync cookie via API
                                $.ajax({
                                    url: "https://" + window.location.host + '/api/setlanguage',
                                    method: 'POST',
                                    contentType: 'application/json',
                                    data: JSON.stringify({ LanguageCode: currentLang }),
                                    async: false
                                });

                                // Sync IndexedDB
                                await new Promise(function(resolve) {
                                    var request = indexedDB.open('goblin-tools-db', 1);
                                    request.onsuccess = function(event) {
                                        var db = event.target.result;
                                        var transaction = db.transaction('settings', 'readwrite');
                                        var store = transaction.objectStore('settings');
                                        store.put(currentLang, 'gt_lang');
                                        transaction.oncomplete = function() { resolve(); };
                                        setTimeout(resolve, 100);
                                    };
                                    request.onerror = function() { resolve(); };
                                });

                                // Add language parameter to URL
                                var linkParams = new URLSearchParams(linkUrl.search);
                                linkParams.set('l', currentLang);
                                linkUrl.search = linkParams.toString();
                            }
                        }

                        // If navigating to homepage on mobile subdomain, add loaded=1 to skip loader
                        var isMobileSubdomain = window.location.hostname === 'ios.goblin.tools' ||
                                               window.location.hostname === 'android.goblin.tools' ||
                                               window.location.hostname === 'localhost';

                        if (isMobileSubdomain &&
                            (linkUrl.pathname === '/' || linkUrl.pathname === '')) {
                            var linkParams = new URLSearchParams(linkUrl.search);
                            if (!linkParams.has('loaded')) {
                                linkParams.set('loaded', '1');
                                linkUrl.search = linkParams.toString();
                            }
                        }

                        // Store the target URL
                        var targetUrl = linkUrl.toString();

                        // Timer IDs for cleanup
                        var initialTimer = null;
                        var longerTimer = null;

                        // Get overlay elements
                        var overlay = document.getElementById('loadingOverlay');
                        var longerText = document.getElementById('loadingLongerText');
                        var cancelBtn = document.getElementById('loadingCancelBtn');

                        // Flag to track if navigation should proceed
                        var shouldNavigate = true;

                        // Navigate (timers will continue until page unloads or they fire)
                        window.location.href = targetUrl;

                        // Function to clear all timers
                        function clearTimers() {
                            if (initialTimer) clearTimeout(initialTimer);
                            if (longerTimer) clearTimeout(longerTimer);
                        }

                        // Cancel button handler
                        cancelBtn.onclick = function() {
                            shouldNavigate = false;
                            clearTimers();
                            overlay.classList.remove('show');
                            window.stop();
                        };

                        // Start 250ms timer
                        initialTimer = setTimeout(function() {
                            if (!shouldNavigate) return;

                            // Show overlay with main loading text (hide longer text and cancel initially)
                            longerText.style.display = 'none';
                            cancelBtn.style.display = 'none';
                            overlay.classList.add('show');

                            // Start 2-second timer for longer text
                            longerTimer = setTimeout(function() {
                                if (!shouldNavigate) return;
                                longerText.style.display = 'block';
                                cancelBtn.style.display = 'block';
                            }, 2000);
                        }, 500);
                    }
                } catch (err) {
                    // If URL parsing fails, let the link work normally
                    return;
                }
            });
        });


    </script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function () {
                navigator.serviceWorker.register('/sw.js').then(function (registration) {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, function (err) {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
    </script>
    
    <script>
        window.i18n = {"todo.estimate":"Estimate","todo.clearEstimate":"Clear estimate","todo.edit":"Edit","todo.remove":"Remove","todo.addSubtask":"Add Subtask","todo.clearSubtasks":"Clear subtasks","time.minutes":"minutes","time.minute":"minute","time.seconds":"seconds","time.second":"second"};
    </script>

    <!-- 100% privacy friendly analytics -->
    <script defer data-hostname="goblin.tools" src="https://stats.goblin.tools/latest.js"></script>
    <noscript b-0bai7cs8n1><img b-0bai7cs8n1 src="https://stats.goblin.tools/noscript.gif?hostname=goblin.tools" alt="" referrerpolicy="no-referrer-when-downgrade" /></noscript>
    <!-- Loading overlay for navigation -->
    <div b-0bai7cs8n1 class="loading-overlay" id="loadingOverlay">
        <div b-0bai7cs8n1 class="loading-overlay-content">
            <div b-0bai7cs8n1 class="loading-spinner"></div>
            <div b-0bai7cs8n1 class="loading-text" data-translate="loading.loading">Loading...</div>
            <div b-0bai7cs8n1 class="loading-longer-text" id="loadingLongerText" data-translate="loading.taking_longer">This is taking longer than expected</div>
            <button b-0bai7cs8n1 class="loading-cancel-btn" id="loadingCancelBtn" data-translate="loading.cancel">Cancel</button>
        </div>
    </div>
</body>
</html>
